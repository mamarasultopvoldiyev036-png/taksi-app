<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tezkor Taksi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- OpenStreetMap Light (tez va sodda) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f8fafc;
            color: #1e293b;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            background: #0066cc;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        /* Xarita - endi majburiy emas, yashirish mumkin */
        .map-container {
            height: 200px;
            margin: 15px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            display: none; /* Yashirin - xohlasangiz ko'rsating */
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .content {
            padding: 15px;
            flex: 1;
        }

        /* Joylashuv kartasi */
        .location-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .location-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #0066cc;
            font-weight: 600;
        }

        .location-address {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            padding: 12px;
            background: #f1f5f9;
            border-radius: 12px;
        }

        .gps-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #64748b;
        }

        .gps-status.active {
            color: #10b981;
        }

        .gps-status.inactive {
            color: #ef4444;
        }

        /* Manzil qidirish */
        .search-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .search-input:focus {
            border-color: #0066cc;
            outline: none;
        }

        /* Tezkor tanlash tugmalari */
        .quick-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .quick-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            text-align: center;
            font-size: 13px;
            cursor: pointer;
        }

        .quick-btn.active {
            background: #0066cc;
            color: white;
        }

        /* Narx kartasi */
        .price-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed #e2e8f0;
        }

        .price-row.total {
            border-bottom: none;
            border-top: 2px solid #0066cc;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 20px;
            font-weight: 700;
            color: #0066cc;
        }

        /* Tugma */
        .btn-order {
            width: 100%;
            padding: 18px;
            background: #0066cc;
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-order:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .message {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }

        .message.show {
            display: block;
        }

        .message.error {
            border-left: 4px solid #ef4444;
        }

        .message.success {
            border-left: 4px solid #10b981;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöñ TEZKOR TAKSI</h1>
    </div>

    <!-- Xarita (yashirin - xohlasangiz ko'rsating) -->
    <div class="map-container" id="mapContainer" style="display: none;">
        <div id="map"></div>
    </div>

    <div class="content">
        <!-- Sizning joylashuvingiz -->
        <div class="location-card">
            <div class="location-header">
                <span>üìç</span>
                <span>Sizning joylashuvingiz</span>
            </div>
            <div class="location-address" id="currentAddress">Aniqlanmoqda...</div>
            <div class="gps-status" id="gpsStatus">
                <span>‚è≥ GPS aniqlanmoqda...</span>
            </div>
        </div>

        <!-- Qayerga boramiz? (MAJBURIY EMAS) -->
        <div class="search-section">
            <div class="location-header">
                <span>üèÅ</span>
                <span>Qayerga boramiz? (ixtiyoriy)</span>
            </div>
            
            <input 
                type="text" 
                class="search-input" 
                id="destinationInput" 
                placeholder="Manzil nomini kiriting (yoki bo'sh qoldiring)"
            >

            <div class="quick-buttons">
                <button class="quick-btn" onclick="setDestination('Xonqiz')">üèò Xonqiz</button>
                <button class="quick-btn" onclick="setDestination('Chimyon')">‚õ∞ Chimyon</button>
                <button class="quick-btn" onclick="setDestination('Mindon')">üè° Mindon</button>
                <button class="quick-btn" onclick="setDestination('')">üöñ Faqat GPS</button>
            </div>
        </div>

        <!-- Narx (faqat masofa bo'lsa) -->
        <div class="price-card" id="priceCard" style="display: none;">
            <div class="price-row">
                <span>üìè Masofa</span>
                <span id="distanceValue">0 km</span>
            </div>
            <div class="price-row">
                <span>üí∞ Boshlang'ich narx</span>
                <span>4,000 so'm</span>
            </div>
            <div class="price-row">
                <span>üìä Yo'l haqi</span>
                <span id="tripPrice">0 so'm</span>
            </div>
            <div class="price-row total">
                <span>Jami:</span>
                <span id="totalPrice">4,000 so'm</span>
            </div>
        </div>

        <!-- Buyurtma berish tugmasi -->
        <button class="btn-order" id="orderBtn" onclick="sendOrder()">
            üöñ BUYURTMA BERISH
        </button>
    </div>

    <!-- Xabarlar -->
    <div class="message" id="errorMessage">
        <span id="errorText"></span>
    </div>
    <div class="message" id="successMessage">
        <span id="successText"></span>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // ==================== BIGDATACLOUD - JOY NOMINI ANIQLASH ====================
        // Bepul, API kalit kerak emas, IP orqali fallback bilan [citation:1]

        let userLat = null;
        let userLon = null;
        let userAddress = '';
        let userCity = '';
        let destination = '';
        
        const BASE_PRICE = 4000;
        const PRICE_PER_KM = 1500;

        // GPS ni boshlash
        function initLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    gpsSuccess,
                    gpsError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                // GPS qo'llab-quvvatlanmasa, IP orqali
                getLocationByIP();
            }
        }

        // GPS muvaffaqiyatli
        async function gpsSuccess(pos) {
            userLat = pos.coords.latitude;
            userLon = pos.coords.longitude;
            
            document.getElementById('gpsStatus').innerHTML = 'üü¢ GPS aniqlandi';
            
            // BigDataCloud orqali manzil nomini olish [citation:10]
            await getAddressFromCoords(userLat, userLon);
            
            // Xaritani ko'rsatish (agar xohlasangiz)
            // showMap(userLat, userLon);
        }

        // GPS xatolik
        function gpsError(err) {
            console.log('GPS xatosi:', err);
            document.getElementById('gpsStatus').innerHTML = 'üü° GPS aniqlanmadi, IP orqali...';
            
            // IP orqali joylashuv [citation:1]
            getLocationByIP();
        }

        // ==================== BIGDATACLOUD REVERSE GEOCODING ====================
        // Koordinatadan manzil nomiga [citation:1][citation:10]
        async function getAddressFromCoords(lat, lon) {
            try {
                const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=uz`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Ma'lumotlarni olish
                const country = data.countryName || '';
                const city = data.city || data.locality || '';
                const locality = data.locality || '';
                
                userCity = city;
                
                // Manzilni yig'ish
                if (city && locality) {
                    userAddress = `${city}, ${locality}`;
                } else if (city) {
                    userAddress = city;
                } else {
                    userAddress = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                }
                
                document.getElementById('currentAddress').innerHTML = userAddress;
                document.getElementById('gpsStatus').innerHTML = '‚úÖ Joylashuv aniqlandi: ' + userCity;
                
            } catch (e) {
                console.error('BigDataCloud xatosi:', e);
                userAddress = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                document.getElementById('currentAddress').innerHTML = userAddress;
            }
        }

        // ==================== IP ORQALI JOYLASHUV (fallback) ====================
        // GPS ishlamasa, IP orqali [citation:1]
        async function getLocationByIP() {
            try {
                const url = 'https://api.bigdatacloud.net/data/reverse-geocode-client?localityLanguage=uz';
                
                const response = await fetch(url);
                const data = await response.json();
                
                const country = data.countryName || '';
                const city = data.city || data.locality || 'Noma\'lum';
                
                userCity = city;
                userAddress = city;
                
                document.getElementById('currentAddress').innerHTML = userAddress + ' (IP orqali)';
                document.getElementById('gpsStatus').innerHTML = 'üü° Taxminiy joylashuv (IP)';
                
                // IP orqali koordinata bo'lmasa, null qoldiramiz
                userLat = null;
                userLon = null;
                
            } catch (e) {
                console.error('IP geolocation xatosi:', e);
                document.getElementById('currentAddress').innerHTML = 'Joylashuv aniqlanmadi';
            }
        }

        // ==================== MANZIL TANLASH (MAJBURIY EMAS) ====================
        function setDestination(dest) {
            destination = dest;
            document.getElementById('destinationInput').value = dest;
            
            if (dest) {
                // Agar manzil tanlangan bo'lsa, taxminiy masofa hisoblash
                const mockDistance = dest === 'Xonqiz' ? 5.2 : 
                                     dest === 'Chimyon' ? 8.7 : 
                                     dest === 'Mindon' ? 3.5 : 3.0;
                
                showPrice(mockDistance);
            } else {
                document.getElementById('priceCard').style.display = 'none';
            }
        }

        // Input o'zgarishi
        document.getElementById('destinationInput').addEventListener('input', function(e) {
            destination = e.target.value;
            if (destination) {
                showPrice(3.0); // Taxminiy masofa
            } else {
                document.getElementById('priceCard').style.display = 'none';
            }
        });

        // Narxni ko'rsatish
        function showPrice(distance) {
            const tripPrice = distance * PRICE_PER_KM;
            const total = BASE_PRICE + tripPrice;
            
            document.getElementById('distanceValue').innerHTML = distance.toFixed(1) + ' km';
            document.getElementById('tripPrice').innerHTML = Math.round(tripPrice / 100) * 100 + ' so\'m';
            document.getElementById('totalPrice').innerHTML = Math.round(total / 100) * 100 + ' so\'m';
            document.getElementById('priceCard').style.display = 'block';
        }

        // ==================== BUYURTMA YUBORISH ====================
        async function sendOrder() {
            if (!userAddress) {
                showError('Joylashuvingiz aniqlanmadi!');
                return;
            }

            const btn = document.getElementById('orderBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Yuborilmoqda...';

            try {
                // Buyurtma ma'lumotlari
                const orderData = {
                    from: userAddress,
                    from_city: userCity,
                    to: destination || '',
                    lat: userLat,
                    lon: userLon,
                    time: new Date().toISOString()
                };

                // Telegramga yuborish
                tg.sendData(JSON.stringify(orderData));
                
                showSuccess('‚úÖ Buyurtma yuborildi!');
                
                setTimeout(() => tg.close(), 1000);
                
            } catch (e) {
                btn.disabled = false;
                btn.innerHTML = 'üöñ BUYURTMA BERISH';
                showError('Xatolik yuz berdi');
            }
        }

        // Xabarlar
        function showError(msg) {
            const el = document.getElementById('errorMessage');
            document.getElementById('errorText').innerHTML = msg;
            el.classList.add('show', 'error');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMessage');
            document.getElementById('successText').innerHTML = msg;
            el.classList.add('show', 'success');
            setTimeout(() => el.classList.remove('show'), 2000);
        }

        // Boshlash
        initLocation();
    </script>
</body>
</html>
